{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container">
<div style="padding:20px">
    <h3  >Create New Recipe</h3>
</div>
<form method="post" action="">
  {% csrf_token %}
  <div>
      {% crispy form %}
  </div>

  <div>
    <button type="button" class="submit-btn btn btn-primary">Create</button>
  </div>

</form>
</div>
<script>
  $("form").change(function () {
    console.log("Form changed")
    let arrayform = $("form").serializeArray();
    input_data = {
        "fermentables": {},
        "hops": {},
        "yeasts": {},
        "extras": {},
        "mash_steps": {}
    }
    for (i = 0; i < arrayform.length; i++) {
      if (arrayform[i].name.includes("FORMS") || arrayform[i].name.includes("csrf")) {continue;}
      else if (arrayform[i].name.startsWith("fermentables-")) {
        var [type, idx, name] = arrayform[i].name.split("-");
        !(idx in input_data[type]) && (input_data[type][idx] = {})
        input_data[type][idx][name] = arrayform[i].value
      }
      else if (arrayform[i].name.startsWith("hops-")) {
        var [type, idx, name] = arrayform[i].name.split("-");
        !(idx in input_data[type]) && (input_data[type][idx] = {})
        input_data[type][idx][name] = arrayform[i].value
      }
      else if (arrayform[i].name.startsWith("yeasts-")) {
        var [type, idx, name] = arrayform[i].name.split("-");
        !(idx in input_data[type]) && (input_data[type][idx] = {})
        input_data[type][idx][name] = arrayform[i].value
      }
      else if (arrayform[i].name.startsWith("extras-")) {
        var [type, idx, name] = arrayform[i].name.split("-");
        !(idx in input_data[type]) && (input_data[type][idx] = {})
        input_data[type][idx][name] = arrayform[i].value
      }
      else if (arrayform[i].name.startsWith("mash_steps-")) {
        var [type, idx, name] = arrayform[i].name.split("-");
        !(idx in input_data[type]) && (input_data[type][idx] = {})
        input_data[type][idx][name] = arrayform[i].value
      }
      else {
        input_data[arrayform[i].name] = arrayform[i].value;
      }
    }
    $.ajax({
      type: "POST",
      headers: { "X-CSRFToken": "{{ csrf_token }}" }, 
      url: '/brew/recipe/info',
      data: {
        'form': JSON.stringify(input_data)
      },
      dataType: 'json',
      success: function (data) {
        console.log(data)
      }
    });

  });
</script>
{% endblock content %}